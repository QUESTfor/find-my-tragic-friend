<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>揪團行事曆 | Group Availability Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #FFFFF0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #333333;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        /* Login Screen */
        .login-screen {
            max-width: 500px;
            margin: 50px auto;
            text-align: center;
        }

        .login-screen h2 {
            color: #333333;
            margin-bottom: 30px;
        }

        .login-screen input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .login-screen input:focus {
            outline: none;
            border-color: #666666;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #333333;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            font-size: 1em;
            margin: 10px 5px;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        /* User Info Bar */
        .user-info {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info span {
            font-size: 1.1em;
            color: #333333;
            font-weight: bold;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .tab.active {
            background: #333333;
            color: white;
            font-weight: bold;
        }

        .tab:hover:not(.active) {
            background: #e0e0e0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Year Selector */
        .year-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .year-selector select {
            padding: 10px 20px;
            font-size: 1.2em;
            border: 2px solid #333333;
            border-radius: 10px;
            background: white;
            color: #333333;
            cursor: pointer;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .month-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }

        .month-header {
            background: #333333;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
        }

        .month-days {
            padding: 15px;
        }

        .day-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .day-item:hover {
            background: #f8f9fa;
            border-color: #999999;
        }

        .day-item.selected {
            background: #e8f4f8;
            border-color: #999999;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-date {
            font-weight: bold;
            color: #333;
        }

        .weekday {
            font-size: 0.9em;
            color: #666;
        }

        .time-slots {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .time-slot {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot:hover {
            background: #f0f0f0;
        }

        .time-slot.selected {
            background: #666666;
            color: white;
            border-color: #666666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: #333333;
            margin-bottom: 20px;
        }

        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .modal-content textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* All Availability View */
        .availability-list {
            max-width: 1000px;
            margin: 0 auto;
        }

        .user-availability {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #666666;
        }

        .user-availability h3 {
            color: #333333;
            margin-bottom: 15px;
        }

        .availability-entry {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .availability-entry strong {
            color: #333;
        }

        .availability-entry .time-info {
            color: #666;
            font-size: 0.95em;
            margin-top: 5px;
        }

        /* Common Availability */
        .common-section {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #2196F3;
        }

        .common-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
        }

        .common-day {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .no-common {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        /* Host Controls */
        .host-controls {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .user-management {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .user-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>揪團行事曆</h1>
            <p>Group Availability Calendar - 找出大家都有空的時間！</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="main-content">
            <div class="login-screen">
                <h2>請輸入您的名字</h2>
                <input type="text" id="nameInput" placeholder="輸入名字..." maxlength="30">
                <br>
                <button class="btn btn-primary" onclick="login()">進入行事曆</button>
                <br><br>
                <button class="btn btn-warning" onclick="showHostLogin()">主持人登入</button>
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <div id="mainApp" style="display: none;">
            <div class="user-info">
                <span><span id="currentUserName"></span></span>
                <button class="btn btn-warning" onclick="logout()">登出</button>
            </div>

            <div class="main-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('calendar')">我的可用時間</button>
                    <button class="tab" onclick="switchTab('all')">所有人的可用時間</button>
                    <button class="tab" onclick="switchTab('common')">共同可用時間</button>
                    <button class="tab" id="hostTab" style="display: none;" onclick="switchTab('host')">主持人控制</button>
                </div>

                <!-- Calendar Tab -->
                <div id="calendarTab" class="tab-content active">
                    <div class="year-selector">
                        <label for="yearSelect">選擇年份：</label>
                        <select id="yearSelect" onchange="renderCalendar()">
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>

                <!-- All Availability Tab -->
                <div id="allTab" class="tab-content">
                    <div id="allAvailability" class="availability-list">
                        <div class="loading">載入中...</div>
                    </div>
                </div>

                <!-- Common Availability Tab -->
                <div id="commonTab" class="tab-content">
                    <div id="commonAvailability">
                        <div class="loading">計算中...</div>
                    </div>
                </div>

                <!-- Host Controls Tab -->
                <div id="hostTab" class="tab-content">
                    <div class="host-controls">
                        <h3>主持人控制面板</h3>
                        <button class="btn btn-danger" onclick="deleteAllUsers()">刪除所有使用者資料</button>
                        <div class="user-management" id="userManagement"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Day Details -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">設定可用時間</h3>
            <div id="modalTimeSlots"></div>
            <label>具體時間範圍（選填）：</label>
            <input type="text" id="specificTime" placeholder="例如：12:30~14:00">
            <label>備註說明（選填）：</label>
            <textarea id="description" placeholder="輸入備註..."></textarea>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveAvailability()">儲存</button>
                <button class="btn btn-warning" onclick="closeModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDJRmVMQ4cXHiPF0vVQcEHf0Z3syeWrDPI",
            authDomain: "find-me-tragic-friend.firebaseapp.com",
            databaseURL: "https://find-me-tragic-friend-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "find-me-tragic-friend",
            storageBucket: "find-me-tragic-friend.firebasestorage.app",
            messagingSenderId: "128404654784",
            appId: "1:128404654784:web:fdcb32ce22e3c606863b25"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.db = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbRemove = remove;
        window.dbOnValue = onValue;

        console.log('Firebase initialized');
    </script>

    <script>
        const HOST_PASSWORD = "itsnotfair"; // Change this to your desired password
        let currentUser = null;
        let isHost = false;
        let selectedDay = null;
        let userAvailability = {};
        let allUsersData = {};

        const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', 
                           '7月', '8月', '9月', '10月', '11月', '12月'];
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        const timeSlots = ['早上', '中午', '晚上'];

        function showHostLogin() {
            const password = prompt('請輸入主持人密碼：');
            if (password === HOST_PASSWORD) {
                const name = prompt('請輸入您的名字：');
                if (name && name.trim()) {
                    currentUser = name.trim();
                    isHost = true;
                    document.getElementById('hostTab').style.display = 'block';
                    initApp();
                }
            } else if (password !== null) {
                alert('密碼錯誤！');
            }
        }

        function login() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('請輸入名字！');
                return;
            }
            currentUser = name;
            initApp();
        }

        function logout() {
            currentUser = null;
            isHost = false;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('nameInput').value = '';
            document.getElementById('hostTab').style.display = 'none';
        }

        function initApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser;
            
            loadUserAvailability();
            renderCalendar();
            
            // Listen to all data changes
            window.dbOnValue(window.dbRef(window.db, 'availability'), (snapshot) => {
                allUsersData = snapshot.val() || {};
                if (document.getElementById('allTab').classList.contains('active')) {
                    renderAllAvailability();
                }
                if (document.getElementById('commonTab').classList.contains('active')) {
                    renderCommonAvailability();
                }
                if (isHost && document.getElementById('hostTab').classList.contains('active')) {
                    renderHostControls();
                }
            });
        }

        function loadUserAvailability() {
            window.dbGet(window.dbRef(window.db, `availability/${currentUser}`))
                .then((snapshot) => {
                    userAvailability = snapshot.val() || {};
                    renderCalendar();
                });
        }

        function renderCalendar() {
            const year = parseInt(document.getElementById('yearSelect').value);
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            for (let month = 0; month < 12; month++) {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = `${year}年 ${monthNames[month]}`;
                monthCard.appendChild(monthHeader);

                const monthDays = document.createElement('div');
                monthDays.className = 'month-days';

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    const dayItem = document.createElement('div');
                    dayItem.className = 'day-item';
                    if (userAvailability[dayKey]) {
                        dayItem.classList.add('selected');
                    }

                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    
                    const dayDate = document.createElement('div');
                    dayDate.className = 'day-date';
                    dayDate.textContent = `${month + 1}/${day}`;
                    
                    const weekday = document.createElement('div');
                    weekday.className = 'weekday';
                    weekday.textContent = `星期${weekdays[date.getDay()]}`;
                    
                    dayHeader.appendChild(dayDate);
                    dayHeader.appendChild(weekday);
                    dayItem.appendChild(dayHeader);

                    // Time slots display
                    const timeSlotsDiv = document.createElement('div');
                    timeSlotsDiv.className = 'time-slots';
                    
                    timeSlots.forEach(slot => {
                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'time-slot';
                        slotDiv.textContent = slot;
                        
                        if (userAvailability[dayKey] && userAvailability[dayKey].slots.includes(slot)) {
                            slotDiv.classList.add('selected');
                        }
                        
                        timeSlotsDiv.appendChild(slotDiv);
                    });
                    
                    dayItem.appendChild(timeSlotsDiv);
                    dayItem.onclick = () => openDayModal(dayKey, `${year}年${month + 1}月${day}日`);
                    
                    monthDays.appendChild(dayItem);
                }

                monthCard.appendChild(monthDays);
                grid.appendChild(monthCard);
            }
        }

        function openDayModal(dayKey, dateStr) {
            selectedDay = dayKey;
            document.getElementById('modalTitle').textContent = `${dateStr} - 設定可用時間`;
            
            const existingData = userAvailability[dayKey] || { slots: [], time: '', description: '' };
            
            const modalSlots = document.getElementById('modalTimeSlots');
            modalSlots.innerHTML = '<div style="margin-bottom: 15px;"><strong>選擇時段：</strong></div><div class="time-slots" style="max-width: 400px;"></div>';
            
            const slotsContainer = modalSlots.querySelector('.time-slots');
            timeSlots.forEach(slot => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'time-slot';
                if (existingData.slots.includes(slot)) {
                    slotDiv.classList.add('selected');
                }
                slotDiv.textContent = slot;
                slotDiv.onclick = () => slotDiv.classList.toggle('selected');
                slotsContainer.appendChild(slotDiv);
            });

            document.getElementById('specificTime').value = existingData.time || '';
            document.getElementById('description').value = existingData.description || '';
            
            document.getElementById('dayModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('dayModal').classList.remove('active');
        }

        function saveAvailability() {
            const selectedSlots = Array.from(document.querySelectorAll('#modalTimeSlots .time-slot.selected'))
                .map(el => el.textContent);
            
            const specificTime = document.getElementById('specificTime').value.trim();
            const description = document.getElementById('description').value.trim();

            if (selectedSlots.length === 0 && !specificTime && !description) {
                // Delete this day's availability
                delete userAvailability[selectedDay];
            } else {
                userAvailability[selectedDay] = {
                    slots: selectedSlots,
                    time: specificTime,
                    description: description
                };
            }

            // Save to Firebase
            window.dbSet(window.dbRef(window.db, `availability/${currentUser}`), userAvailability)
                .then(() => {
                    closeModal();
                    renderCalendar();
                    alert('儲存成功！');
                })
                .catch(error => {
                    console.error('Error saving:', error);
                    alert('儲存失敗，請重試！');
                });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');

            if (tabName === 'all') {
                renderAllAvailability();
            } else if (tabName === 'common') {
                renderCommonAvailability();
            } else if (tabName === 'host') {
                renderHostControls();
            }
        }

        function renderAllAvailability() {
            const container = document.getElementById('allAvailability');
            container.innerHTML = '';

            if (Object.keys(allUsersData).length === 0) {
                container.innerHTML = '<div class="no-common">目前還沒有任何人填寫資料</div>';
                return;
            }

            Object.keys(allUsersData).sort().forEach(userName => {
                const userData = allUsersData[userName];
                const userDiv = document.createElement('div');
                userDiv.className = 'user-availability';
                
                let html = `<h3>${userName}</h3>`;
                
                const sortedDays = Object.keys(userData).sort();
                if (sortedDays.length === 0) {
                    html += '<div class="no-common">尚未填寫任何可用時間</div>';
                } else {
                    sortedDays.forEach(day => {
                        const data = userData[day];
                        html += `<div class="availability-entry">
                            <strong>${day}</strong> - ${data.slots.join(', ')}
                            ${data.time ? `<div class="time-info">時間: ${data.time}</div>` : ''}
                            ${data.description ? `<div class="time-info">備註: ${data.description}</div>` : ''}
                        </div>`;
                    });
                }
                
                userDiv.innerHTML = html;
                container.appendChild(userDiv);
            });
        }

        function renderCommonAvailability() {
            const container = document.getElementById('commonAvailability');
            container.innerHTML = '';

            const users = Object.keys(allUsersData);
            if (users.length < 2) {
                container.innerHTML = '<div class="no-common">需要至少 2 位使用者才能計算共同時間</div>';
                return;
            }

            // Level 1: Common time slots
            const level1 = calculateCommonSlots(users);
            
            const section1 = document.createElement('div');
            section1.className = 'common-section';
            section1.innerHTML = '<h3>Level 1：所有人都選擇的相同時段</h3>';
            
            if (level1.length === 0) {
                section1.innerHTML += '<div class="no-common">沒有找到所有人都可用的相同時段</div>';
            } else {
                level1.forEach(item => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'common-day';
                    dayDiv.innerHTML = `
                        <strong>${item.date}</strong><br>
                        時段：${item.slots.join(', ')}<br>
                        <small>所有 ${users.length} 位使用者都可用</small>
                    `;
                    section1.appendChild(dayDiv);
                });
            }
            container.appendChild(section1);

            // Level 2: Overlapping specific times
            const level2 = calculateOverlappingTimes(users);
            
            const section2 = document.createElement('div');
            section2.className = 'common-section';
            section2.innerHTML = '<h3>Level 2：具體時間重疊</h3>';
            
            if (level2.length === 0) {
                section2.innerHTML += '<div class="no-common">沒有找到具體時間重疊（需要使用者填寫具體時間範圍）</div>';
            } else {
                level2.forEach(item => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'common-day';
                    dayDiv.innerHTML = `
                        <strong>${item.date}</strong><br>
                        重疊時間：${item.overlap}<br>
                        <small>參與者：${item.users.join(', ')}</small>
                    `;
                    section2.appendChild(dayDiv);
                });
            }
            container.appendChild(section2);
        }

        function calculateCommonSlots(users) {
            const commonDays = [];
            const allDays = new Set();
            
            // Collect all days
            users.forEach(user => {
                Object.keys(allUsersData[user] || {}).forEach(day => allDays.add(day));
            });

            // Check each day
            allDays.forEach(day => {
                // Check if all users have this day
                const usersWithDay = users.filter(user => allUsersData[user] && allUsersData[user][day]);
                
                if (usersWithDay.length === users.length) {
                    // Find common slots
                    const firstUserSlots = allUsersData[users[0]][day].slots;
                    const commonSlots = firstUserSlots.filter(slot => 
                        users.every(user => allUsersData[user][day].slots.includes(slot))
                    );
                    
                    if (commonSlots.length > 0) {
                        commonDays.push({ date: day, slots: commonSlots });
                    }
                }
            });

            return commonDays.sort((a, b) => a.date.localeCompare(b.date));
        }

        function calculateOverlappingTimes(users) {
            const overlaps = [];
            const allDays = new Set();
            
            users.forEach(user => {
                Object.keys(allUsersData[user] || {}).forEach(day => allDays.add(day));
            });

            allDays.forEach(day => {
                const usersWithTime = [];
                
                users.forEach(user => {
                    if (allUsersData[user] && allUsersData[user][day] && allUsersData[user][day].time) {
                        const timeRange = parseTimeRange(allUsersData[user][day].time);
                        if (timeRange) {
                            usersWithTime.push({ user, ...timeRange });
                        }
                    }
                });

                if (usersWithTime.length >= 2) {
                    const overlap = findOverlap(usersWithTime);
                    if (overlap) {
                        overlaps.push({
                            date: day,
                            overlap: overlap.range,
                            users: overlap.users
                        });
                    }
                }
            });

            return overlaps.sort((a, b) => a.date.localeCompare(b.date));
        }

        function parseTimeRange(timeStr) {
            const match = timeStr.match(/(\d{1,2}):(\d{2})\s*[~\-]\s*(\d{1,2}):(\d{2})/);
            if (!match) return null;
            
            const startMinutes = parseInt(match[1]) * 60 + parseInt(match[2]);
            const endMinutes = parseInt(match[3]) * 60 + parseInt(match[4]);
            
            return { start: startMinutes, end: endMinutes };
        }

        function findOverlap(userTimes) {
            if (userTimes.length < 2) return null;
            
            let maxStart = Math.max(...userTimes.map(ut => ut.start));
            let minEnd = Math.min(...userTimes.map(ut => ut.end));
            
            if (maxStart < minEnd) {
                const startHour = Math.floor(maxStart / 60);
                const startMin = maxStart % 60;
                const endHour = Math.floor(minEnd / 60);
                const endMin = minEnd % 60;
                
                return {
                    range: `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}~${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`,
                    users: userTimes.map(ut => ut.user)
                };
            }
            
            return null;
        }

        function renderHostControls() {
            const container = document.getElementById('userManagement');
            container.innerHTML = '';

            const users = Object.keys(allUsersData).sort();
            
            if (users.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999;">目前沒有使用者資料</div>';
                return;
            }

            users.forEach(userName => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <span>${userName}</span>
                    <button class="btn btn-danger" onclick="deleteUser('${userName}')">刪除</button>
                `;
                container.appendChild(userItem);
            });
        }

        function deleteUser(userName) {
            if (confirm(`確定要刪除 ${userName} 的所有資料嗎？`)) {
                window.dbRemove(window.dbRef(window.db, `availability/${userName}`))
                    .then(() => {
                        alert('已刪除！');
                        renderHostControls();
                    })
                    .catch(error => {
                        console.error('Error deleting user:', error);
                        alert('刪除失敗！');
                    });
            }
        }

        function deleteAllUsers() {
            if (confirm('警告！確定要刪除所有使用者的資料嗎？此操作無法復原！')) {
                const confirmText = prompt('請輸入 "DELETE ALL" 以確認刪除所有資料：');
                if (confirmText === 'DELETE ALL') {
                    window.dbRemove(window.dbRef(window.db, 'availability'))
                        .then(() => {
                            alert('所有資料已刪除！');
                            allUsersData = {};
                            userAvailability = {};
                            renderHostControls();
                            renderCalendar();
                        })
                        .catch(error => {
                            console.error('Error deleting all:', error);
                            alert('刪除失敗！');
                        });
                }
            }
        }
    </script>
</body>
</html>
